<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>DependabotのAutoMergeで必要十分なCIをmerge条件にする &#183; からまるのブログ</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/ren.png><link href rel=alternate type=application/rss+xml title=からまるのブログ><meta property="og:title" content="DependabotのAutoMergeで必要十分なCIをmerge条件にする"><meta property="og:description" content="Githubの仕様に戸惑ったので備忘録的に書きます。"><meta property="og:type" content="article"><meta property="og:url" content="https://karamaru-alpha.com/posts/dependabot-auto-merge/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-09T00:16:21+09:00"><meta property="article:modified_time" content="2024-08-09T00:16:21+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="DependabotのAutoMergeで必要十分なCIをmerge条件にする"><meta name=twitter:description content="Githubの仕様に戸惑ったので備忘録的に書きます。"><script src=/js/darkmode.js></script></head><body><nav class=nav><div class=nav-container><a href=/><h2 class=nav-title>からまるのブログ</h2></a><ul><li><a href=https://github.com/karamaru-alpha target=_blank rel="noopener noreferrer"><span>GitHub</span></a></li><li><a href=https://x.com/karamaru_alpha target=_blank rel="noopener noreferrer"><span>X</span></a></li><li><a href=https://speakerdeck.com/karamaru target=_blank rel="noopener noreferrer"><span>SpeackerDeck</span></a></li><li><a href=https://sizu.me/karamaru_alpha target=_blank rel="noopener noreferrer"><span>SizuIn</span></a></li><li><a href=https://www.linkedin.com/in/karamaru target=_blank rel="noopener noreferrer"><span>LinkedIn</span></a></li><li><a href=https://karamaru-alpha.com/index.xml target=_blank rel="noopener noreferrer"><span>RSS</span></a></li></ul></div></nav><div id=darkModeToggle onclick=toggleDarkMode()>&#9680;</div><main><div class=post><div class=post-info><time datetime="2024-08-09 00:16:21 +0900 +0900">2024/08/09</time></div><h1 class=post-title>DependabotのAutoMergeで必要十分なCIをmerge条件にする</h1><div class=post-line></div><p>Githubの仕様に戸惑ったので備忘録的に書きます。</p><h2 id=先に結論>先に結論</h2><ol><li>dependabotでpatchバージョンの更新は自動マージしたい</li><li>有効なCI全てのpassをmerge条件にしたい</li></ol><h2 id=1-dependabotでpatchバージョンの更新は自動マージする>1. dependabotでpatchバージョンの更新は自動マージする</h2><p><a href=https://semver.org/lang/ja/>セマンティックバージョニング</a>によると、patchバージョンのリリースは後方互換を保つ軽微なバグ修正などで行われるべきとされています。</p><p>dependabotのPRを目視するのは新機能が追加された時(minor)や後方互換性が保たれなくなった時(major)のみにしたいと思ったので、dependabotが上げるPRの最大差分がpatchバージョンならAutoMergeさせるようにしました。</p><p>手順は公式が用意してくれているのでスーパーイージーですね。</p><p>cf. <a href=https://docs.github.com/ja/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions#common-dependabot-automations>https://docs.github.com/ja/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions#common-dependabot-automations</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Dependabot auto-merge</span>
<span style=color:#f92672>on</span>: <span style=color:#ae81ff>pull_request</span>

<span style=color:#f92672>permissions</span>:
  <span style=color:#f92672>contents</span>: <span style=color:#ae81ff>write</span>
  <span style=color:#f92672>pull-requests</span>: <span style=color:#ae81ff>write</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>dependabot</span>:
    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.actor == &#39;dependabot[bot]&#39;</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Dependabot metadata</span>
        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>metadata</span>
        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>dependabot/fetch-metadata@v2</span>
        <span style=color:#f92672>with</span>:
          <span style=color:#f92672>github-token</span>: <span style=color:#e6db74>&#34;${{ secrets.GITHUB_TOKEN }}&#34;</span>
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enable auto-merge for Dependabot PRs</span>
        <span style=color:#f92672>if</span>: <span style=color:#ae81ff>contains(steps.metadata.outputs.dependency-names, &#39;my-dependency&#39;) &amp;&amp; steps.metadata.outputs.update-type == &#39;version-update:semver-patch&#39;</span>
        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>gh pr merge --auto --merge &#34;$PR_URL&#34;</span>
        <span style=color:#f92672>env</span>:
          <span style=color:#f92672>PR_URL</span>: <span style=color:#ae81ff>${{github.event.pull_request.html_url}}</span>
          <span style=color:#f92672>GH_TOKEN</span>: <span style=color:#ae81ff>${{secrets.GITHUB_TOKEN}}</span>
</code></pre></div><h2 id=2-有効なci全てのpassをmerge条件にする>2. 有効なCI全てのpassをmerge条件にする</h2><p>全てのライブラリがセマンティックバージョニングを採用しているわけではないため、このままCIを通さずにmergeさせるのは避けたいところですね。 ちなみに、<code>gh pr merge --auto</code>はマージ条件を満たしたらmergeするよ！というコマンドで、これを利用していきたいわけです。</p><p>さて、CIをmerge条件にするにはブランチプロテクションの以下「???」のところにJob名を指定する必要があります。</p><p><img src=img.png alt=img.png></p><p>ここで問題となってくるのが、ステータスチェックの挙動です。例えばGoとJsのモノレポがあったとして、それぞれlinterを走らせるworkflow/jobがあるとします。 そして、以下<code>go-lint</code>と<code>js-lint</code>をマージ要件として設定します。</p><p>Q. この状態でGoのライブラリpatchアップデートを行うdependabotのPRが生まれた時、そのPRは自動でマージされるでしょうか？</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># .github/workflows/pull-request-for-go.yml</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>Pull Request for Go</span>

<span style=color:#f92672>on</span>:
  <span style=color:#f92672>pull_request</span>:
    <span style=color:#f92672>paths</span>:
      - <span style=color:#e6db74>&#39;**.go&#39;</span>
      - <span style=color:#ae81ff>go.mod</span>
      - <span style=color:#ae81ff>go.sum</span>
      - <span style=color:#ae81ff>.github/workflows/pull-request-for-go.yml</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>lint</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>go-lint</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># .github/workflows/pull-request-for-js.yml</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>Pull Request for JS</span>

<span style=color:#f92672>on</span>:
  <span style=color:#f92672>pull_request</span>:
    <span style=color:#f92672>paths</span>:
      - <span style=color:#e6db74>&#39;web/**&#39;</span>
      - <span style=color:#ae81ff>.github/workflows/pull-request-for-js.yml</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>lint</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>js-lint</span>
</code></pre></div><p>答えはNoで、マージ要件が満たされずに自動マージが無効になります。</p><p>ドキュメントをみてみると、 workflowの<strong>path/branchフィルターで実行されなかったJobについてはステータスチェックがpassされない</strong>ということが明記されています。(一方Jobの条件分岐でskipされた場合はpassする)</p><blockquote><p>If a workflow is skipped due to path filtering, branch filtering or a commit message, then checks associated with that workflow will remain in a &ldquo;Pending&rdquo; state. A pull request that requires those checks to be successful will be blocked from merging. If, however, a job within a workflow is skipped due to a conditional, it will report its status as &ldquo;Success&rdquo;. For more information, see &ldquo;Using conditions to control job execution.&rdquo;</p></blockquote><p>cf. <a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/collaborating-on-repositories-with-code-quality-features/troubleshooting-required-status-checks#handling-skipped-but-required-checks>https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/collaborating-on-repositories-with-code-quality-features/troubleshooting-required-status-checks#handling-skipped-but-required-checks</a></p><p>つまり、Goのライブラリアップデートがあった上記例では、<code>js-lint</code>がpathフィルターで実行されずステータスチェックをpassできなくなっており、merge制約に引っかかってしまっていたんですね。</p><p>さて、必要十分なCIの成功を待ってdependabotのPRをAutoMergeさせるのにはどんな方法があるでしょうか？ いくつかの(というか考えられる全ての)方法は、偉大な先人が以下に記してくれていました。</p><p>cf. <a href=https://zenn.dev/bigwheel/articles/05accc6323de18>モノレポで不要なGithub Actions実行を最小にしつつマージブロック機能(マージ前必須チェックステータス)を使う方法の検討</a></p><p>記事に倣い、私も<strong>Job名統一法</strong>を選択しました。
APIのポーリングはVM代もかかりますし、全てのworkflowのfilterをjob側に付けるのも記法が大きくブレるので今回は見送りました。</p><p><code>Require status checks to pass before merging</code>でCIを設定したい場合Job名を指定します。
複数マッチした場合は全て成功である必要があり、1つもマッチしない場合は落ちます。</p><p>よって、マージ制約として設けたいJobの名前を統一しつつ、全てのワークフローが走らなかった場合でもマージできるように必ず成功するワークフローをダミーでおくことで、必要十分なCIのpassをマージ条件にすることができます。</p><p><img src=img_1.png alt=img_1.png></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># .github/workflows/pull-request-for-go.yml</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>Pull Request for Go</span>

<span style=color:#f92672>on</span>:
  <span style=color:#f92672>pull_request</span>:
    <span style=color:#f92672>paths</span>:
      - <span style=color:#e6db74>&#39;**.go&#39;</span>
      - <span style=color:#ae81ff>go.mod</span>
      - <span style=color:#ae81ff>go.sum</span>
      - <span style=color:#ae81ff>.github/workflows/pull-request-for-go.yml</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>lint</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>check</span> <span style=color:#75715e># &#34;check&#34;で命名統一</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># .github/workflows/pull-request-for-js.yml</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>Pull Request for JS</span>

<span style=color:#f92672>on</span>:
  <span style=color:#f92672>pull_request</span>:
    <span style=color:#f92672>paths</span>:
      - <span style=color:#e6db74>&#39;web/**&#39;</span>
      - <span style=color:#ae81ff>.github/workflows/pull-request-for-js.yml</span>

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>lint</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>check</span> <span style=color:#75715e># &#34;check&#34;で命名統一</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># .github/workflows/nop.yml</span>
<span style=color:#75715e># NOTE: 常にJobスキップするWorkflow</span>
<span style=color:#75715e># Githubにおけるmerge制約でCI(Job)を指定した場合、名前でマッチした全てのJobが成功した時のみステータスチェックが通る。1つもマッチしない場合は落ちる。</span>
<span style=color:#75715e># merge制約に設けたいJob名を&#34;check&#34;で統一し、それら全てがスキップされた場合もmergeできるように常にJobスキップ(成功)するWorkflowを用意する。</span>
<span style=color:#75715e># cf.https://docs.github.com/en/enterprise-server@3.7/pull-requests/collaborating-with-pull-requests/collaborating-on-repositories-with-code-quality-features/troubleshooting-required-status-checks</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>NOP</span>

<span style=color:#f92672>on</span>:
  <span style=color:#f92672>pull_request</span>:

<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>nop</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>check</span>
    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
    <span style=color:#f92672>if</span>: <span style=color:#66d9ef>false</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>exit 0</span>
</code></pre></div><p>わーい！これで必要十分なCIの完了を待ちつつ、dependabotのAutoMergeを実現することができましたね！</p></div><div class=pagination><a href=/posts/golangci-lint-measure/ class="left arrow">&#8592;</a>
<a href=/posts/unique-package/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2025-01-07 09:54:49.626096185 +0000 UTC m=+0.053994258">2025</time> karamaru. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>