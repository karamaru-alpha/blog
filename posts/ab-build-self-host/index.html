<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>【Unity】アセットバンドルビルド環境を脱JenkinsしてGithubActionsセルフホステッドランナーにした話 &#183; からまるのブログ</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/ren.png><link href rel=alternate type=application/rss+xml title=からまるのブログ><meta property="og:title" content="【Unity】アセットバンドルビルド環境を脱JenkinsしてGithubActionsセルフホステッドランナーにした話"><meta property="og:description" content="ゲーム業界で伝統的に使われているABビルド*Jenkins構成を使わないために頑張っている話"><meta property="og:type" content="article"><meta property="og:url" content="https://karamaru-alpha.com/posts/ab-build-self-host/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-09T00:16:21+09:00"><meta property="article:modified_time" content="2024-08-09T00:16:21+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="【Unity】アセットバンドルビルド環境を脱JenkinsしてGithubActionsセルフホステッドランナーにした話"><meta name=twitter:description content="ゲーム業界で伝統的に使われているABビルド*Jenkins構成を使わないために頑張っている話"><script src=/js/darkmode.js></script></head><body><nav class=nav><div class=nav-container><a href=/><h2 class=nav-title>からまるのブログ</h2></a><ul><li><a href=https://github.com/karamaru-alpha target=_blank rel="noopener noreferrer"><span>GitHub</span></a></li><li><a href=https://x.com/karamaru_alpha target=_blank rel="noopener noreferrer"><span>X</span></a></li><li><a href=https://speakerdeck.com/karamaru target=_blank rel="noopener noreferrer"><span>SpeackerDeck</span></a></li><li><a href=https://www.linkedin.com/in/karamaru target=_blank rel="noopener noreferrer"><span>LinkedIn</span></a></li><li><a href=https://karamaru-alpha.com/index.xml target=_blank rel="noopener noreferrer"><span>RSS</span></a></li></ul></div></nav><div id=darkModeToggle onclick=toggleDarkMode()>&#9680;</div><main><div class=post><div class=post-info><time datetime="2024-08-09 00:16:21 +0900 +0900">2024/08/09</time></div><h1 class=post-title>【Unity】アセットバンドルビルド環境を脱JenkinsしてGithubActionsセルフホステッドランナーにした話</h1><div class=post-line></div><p>ゲーム業界で伝統的に使われているABビルド*Jenkins構成を使わないために頑張っている話</p><h2 id=先に結論>先に結論</h2><ul><li>Jenkins<em>MacProからGithubActions</em>EC2にしたよ</li></ul><h2 id=従来の構成jenkinsmacpro>従来の構成(Jenkins*MacPro)</h2><h3 id=jenkinsを使っていた背景>Jenkinsを使っていた背景</h3><p>弊プロジェクトでは従来までJenkins*MacProという構成でアセットバンドルビルドを含む多くのタスクを実行していました。
ECSなどにJenkinsControllerとしてWebUIを、物理PCにJenkinsAgentを入れてタスクランナーとして使う感じですね。</p><p>ゲーム業界でJenkinsが使用されている理由は<a href=https://hikyaru-suzuki.hatenablog.jp/entry/2022/12/19/140000>こちらのブログ</a>が全て語ってくれています。
まとめると以下です。</p><ul><li><strong>前回の実行環境を引き継いで実行したい</strong><ul><li>キャッシュを使いたいがその量が(特にアセット関係は)膨大でactions/cacheの上限(10GB)を超えてしまう</li></ul></li><li><strong>エンジニア以外でも実行できる/見やすいUIを用意したい</strong><ul><li>非エンジニアが実行する機会が多いため、githubアカウントを持っていない人でも実行できる環境と見た目が欲しい</li></ul></li><li>従量課金でないこと</li></ul><p>そしてJenkins*MacPro構成のデメリットは以下です。</p><ul><li>Jenkins自体のメンテナンスコストが高い。pluginのアップデートなど</li><li>GitHub上でタスク定義を管理できない</li><li>物理PCをメンテナンスし続けるのが大変</li><li>タスクランナーのマシンスペックが固定される</li></ul><p>さて、今回は上記のようなデメリットを解消するため、ゲーム業界で伝統的に使われているJenkinsを全てActionsに移行するまで頑張ってみようという話です。</p><h2 id=新しい構成githubactionsec2>新しい構成(GithubActions*EC2)</h2><h3 id=方針>方針</h3><p>アセットバンドルビルドは依存が多くキャッシュの量も膨大なので、例えばGithubHostedRunnerのように実行環境が毎回クリーンな環境は適していません。</p><p>そこで、EC2をGithubActionsのセルフホステッドランナーとして登録させそれを起動・停止させる方法をとることにしました。
特定のVMをセルフホステットランナーにする方法は<a href=https://docs.github.com/ja/actions/hosting-your-own-runners/managing-self-hosted-runners/configuring-the-self-hosted-runner-application-as-a-service>公式から案内</a>があります。
systemdのserviceとして登録することで、VM起動時にrunnerとして認識してくれるようになります。便利ですね。</p><p><img src=arch.png alt=arch.png></p><p>本当であれば安価なスポットインスタンスを使用したいところでしたが、市場にリソースが余ってないと起動できないことや、インスタンスサイズを動的に変更できないなどのデメリットから見送り(オンデマンドVM)となりました。</p><p>この構成にすることのメリットは以下です</p><ul><li>前回の実行環境を引き継いでCI実行できる(ルートボリュームであるEBSを引き回せるためファイル状態はそのまま引き継げる)</li><li>インスタンスタイプを動的に変更することでマシンパワーを必要な時に必要な分だけ取得できる</li><li>タスクの実行をyaml(GitOps)で管理できる</li><li>sshやRDP接続を許可することで物理マシンに遜色ないランナーへのデバッグを行うことができる</li></ul><p>さて、GithubアカウントがあればActions画面からDispatch可能です。</p><p><img src=actions.png alt=actions.png></p><p>一方で、全ての実行者がGithubアカウントを持っていないケースも存在すると思います。弊プロジェクトもその例にもれなかった、UIは別途自作する必要がありました。
SlackAppか管理画面に統合するかで迷ったのですが、視認性や取り回しやすさから今回は管理画面に統合することにしました。</p><p>アカウントがなくてもLogやArtifact(成果物)を一定閲覧できるようにしました。</p><p><img src=img.png alt=img.png></p><h2 id=終わりに>終わりに</h2><p>以上がアセットバンドルビルドにおける脱Jenkinsを頑張っている話でした。 他にもいい案があれば募集中です！</p><p>他にもUnityAcceleratorを建てた話とかも書きたいなあ</p></div><div class=pagination><a href=/posts/2024-second-half/ class="left arrow">&#8592;</a>
<a href=/posts/golangci-lint-measure/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2024-08-09 02:03:48.780486568 +0000 UTC m=+0.037963976">2024</time> karamaru. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>